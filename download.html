<!DOCTYPE html>
<html>

<head>
    <title>svift demo</title>
    <meta charset="utf-8">

    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="manifest" href="favicon/manifest.json">
    <link rel="mask-icon" href="favicon/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="favicon/favicon.ico">
    <meta name="msapplication-config" content="favicon/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">

    <script src="build/d3.v4.min.js"></script>
    <script src="build/svift.min.js"></script>

    <link rel="stylesheet" href="styles/app/normalize.css">
    <link rel="stylesheet" href="styles/download/download.css">
    <style type="text/css">
        #error, #download{
            display: none;
        }

    </style>
</head>

<body>
    <div id="download" class="download">
        <div class="ct">
            <iframe style="width:500px; height:500px;"></iframe>
            <textarea id="embed"></textarea>
            <div ct-head>
                <h1>Download your SVIFT chart</h1>
                <h2>Choose your preferred format</h2>
            </div>
            <div class="ct-body">
            </div>
            <div class="ct-foot">
                <div class="source"></div>
            </div>
        </div>
    </div>
    <div id="loading">Loading - Robot Face (robot face maybe)</div>
    <div id="error"></div>

    <script>
        var id = window.location.hash.substr(1),
            aws = 'https://s3.eu-central-1.amazonaws.com/svift-vis-output/output/'+id;

        d3.json(aws+'/contents.json', function(err, data){
            d3.select('#loading').style('display','none');
            if(err){
                d3.select('#error').style('display','block').html('We could not find your visualisation.<br />We only store visualisations for 10 days.');
            }else{
                d3.select('#download').style('display','block');
                d3.select('#embed').html('<iframe style="width:500px; height:500px;" src="' + aws + '/html/index.html"></iframe>');
                d3.select('iframe').attr('src', aws + '/html/index.html');

                //TODO: if required, the data item holds the date when the vis was created : data.date

                var groups = [];

                for(var key in data){
                    if(key != 'date' && key != 'html'){
                        data[key].forEach(function(d,i){
                            data[key][i].link = aws+'/';
                            switch(key){
                                case 'zips':
                                    data[key][i].link += d.file + '.zip';
                                break;
                                case 'social':
                                    data[key][i].link += 'social/' + d.file + '.png';
                                break;
                                case 'files':
                                    data[key][i].link += id + '.' + d.file;
                                break;
                            }
                        });
                        groups.push({
                            key:key,
                            value:data[key]
                        });
                    }
                }
                var groups = d3.select('.ct-body').selectAll('div').data(groups).enter().append('div').attr('class', function(d){ return 'group g-'+d.key;});
                groups.selectAll('.dl-icon').data(function(d){return d.value;}).enter().append('div')
                    .attr('class','dl-icon')
                    .append('a')
                    .attr('href', function (d) { return d.link; })
                    .text(function(d){
                        return d.name;
                    })
                    .append('img')
                    .attr('src', function (d) { d.icon = 'download'; return 'assets/img/download-icons/' + d.icon + '.svg' })
                    .attr('class', 'dl-img')
                    .attr('id', function (d) { return 'dl- icon - ' + d.class });


            //TODO: This should be replaced through the correct final url
            var url = 'http://svift.xyz/users/653792';
            d3.select('.source').text('All of your charts will be available for 10 more days at: ' + url);
            }
        });
    </script>

</body>

</html>